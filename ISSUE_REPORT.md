# Проблема: скачок при вращении после зума

## Краткое описание
После зума колесом при первом вращении ЛКМ происходит резкий «скачок» (смещение камеры/модели).  
Скачок воспроизводится в Яндекс Браузере с мышью.  
Зум по курсору работает и должен сохраняться (точка под курсором должна оставаться на месте).

## Ожидаемое поведение
1) Зум по курсору — точка под курсором остаётся на месте.  
2) Ось вращения — центр модели.  
3) При первом движении вращения после зума **нет скачка**.

## Фактическое поведение
При первом движении вращения после зума происходит резкий скачок.  
При отключении ребейза pivot скачок исчезал, но ось вращения уезжала (вращение «вокруг сцены»).

## Среда
- Браузер: Яндекс  
- Устройство ввода: мышь  
- ОС: Windows 10  

## Диагностика и наблюдения

### 1) Zoom-to-cursor логи (были ранее)
Логи показывали, что `didCompensate=true`, `anchorDriftPxBefore/After=0`, но при зуме меняется `target`.  
Примеры (сокращённо):
- `src: "model-hit"`, `plane: "anchor-plane"`, `canCompensate: true`  
- `targetBefore/After` меняются заметно при зуме  

Это указывает, что зум по курсору работает через компенсацию и сдвиг `controls.target`.

### 2) OrbitDebug логи (раньше)
Скачок происходил при событии `rebase`:
- Пример 1:
  - `before.target`: `{ x: -4.092, y: 12.587, z: 4.274 }`
  - `after.target`: `{ x: -6.081, y: 8.118, z: 3.743 }`
  - `delta.target`: `{ x: -1.99, y: -4.47, z: -0.532 }`
  - `delta.cam`: `{ x: -2.35, y: -4.47, z: -1.282 }`
- Пример 2:
  - `before.target`: `{ x: -7.863, y: 2.844, z: 7.362 }`
  - `after.target`: `{ x: -6.081, y: 8.118, z: 3.743 }`
  - `delta.target`: `{ x: 1.782, y: 5.273, z: -3.619 }`
  - `delta.cam`: `{ x: 1.8, y: 5.273, z: -2.934 }`

Вывод: скачок фиксируется в момент ребейза pivot (перемещение `controls.target` к центру модели).

### 3) Проверка без ребейза
При отключении ребейза скачок исчезал, но ось вращения «уезжала» от модели и вращение шло вокруг удалённой точки.

## Важные шаги, сделанные в этом чате

1) Подтверждено:
   - Скачок есть даже без zoom-to-cursor (`?zoomCursor=0`), значит источник в логике ребейза pivot, а не в wheel.

2) Диагностические шаги:
   - Включались `OrbitDebug` логи и фиксировался `rebase`.
   - Скачок совпал с `rebase`.
   - При отключении ребейза скачок исчезал, но ломалась ось вращения.

3) Изменения/эксперименты:
   - Несколько попыток переноса ребейза (в `pointermove`, после зума, с компенсацией) приводили к конфликту:
     - либо ломался зум по курсору,
     - либо возвращался скачок,
     - либо уезжала ось вращения.

4) Итоговое состояние на момент передачи:
   - Пользователь сделал откат к рабочему зуму по курсору.
   - Скачок при первом вращении после зума остаётся.
   - Требование: сохранить точный зум по курсору и убрать скачок.

## Где искать проблему в коде
- `src/viewer/ZoomToCursorController.js`  
  Логика зума по курсору, компенсация сдвига:
  - `camera.position.add(delta);`
  - `controls.target.add(delta);`

- `src/viewer/Viewer.js`  
  Ребейз pivot перед вращением:
  - `#rebaseRotatePivotToModelCenterIfNeeded()`
  - обработчики `pointerdown` / `controls.change`

## Гипотеза по наблюдениям (не утверждение причины)
Скачок происходит из-за ребейза `controls.target` **после** того, как OrbitControls уже начал вращение.  
Если ребейз делать до старта вращения (capture‑phase) и строго после зума, скачок может исчезнуть, но важно не ломать зум по курсору.

## Требуемое решение
Нужно сохранить:
- точный zoom‑to‑cursor (угол под курсором не уходит),  
- ось вращения строго в центре модели,  
и при этом убрать скачок при первом движении вращения после зума.

